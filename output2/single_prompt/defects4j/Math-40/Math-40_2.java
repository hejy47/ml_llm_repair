There are no obvious bugs in this function, but it could benefit from some improvements in readability and maintainability. Here are some suggestions:

- Add more comments to explain the purpose of each section of code and how they contribute to the overall algorithm.
- Extract some of the conditional blocks into separate methods with descriptive names to make the code more modular and easier to understand.
- Consider using more descriptive variable names to better indicate what each variable means and how it is used.