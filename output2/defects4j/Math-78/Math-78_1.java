There are no clear indications of what the buggy part of the function is. Without further information, it is not possible to provide a fix for the function.